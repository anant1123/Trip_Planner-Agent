import streamlit as st
import requests
import time
from main import get_trip_plan


# =========================
#  Location Search Function
# =========================
def search_location(query):
    if not query:
        return []

    # Respect Nominatim rate limit
    time.sleep(1)

    url = "https://nominatim.openstreetmap.org/search"
    params = {
        "q": query,
        "format": "json",
        "addressdetails": 1,
        "limit": 5
    }
    headers = {"User-Agent": "TripGenie-AI-Student-Project"}

    res = requests.get(url, params=params, headers=headers)
    results = res.json()

    locations = []

    for r in results:
        addr = r.get("address", {})

        locations.append({
            "label": r.get("display_name"),
            "city": addr.get("city") or addr.get("town") or addr.get("village"),
            "state": addr.get("state"),
            "country": addr.get("country"),
            "lat": r.get("lat"),
            "lon": r.get("lon")
        })

    return locations


# =========================
#   STREAMLIT UI START
# =========================
st.set_page_config(page_title="TripGenie", page_icon="üåç", layout="centered")

st.title("üåç TripGenie ‚Äî AI Travel Planner")
st.write("Plan meaningful trips powered by real-time data ‚úàÔ∏èüöÜüè®")


# =========================
#   ABOUT SECTION
# =========================
with st.expander("‚ÑπÔ∏è About TripGenie"):
    st.markdown("""
**TripGenie** is a non-commercial AI travel planner built for learning.

It helps you:
- ‚úàÔ∏è find affordable flights  
- üè® choose budget friendly hotels  
- üçΩ discover local food  
- üó∫ get clean day-by-day itineraries  

‚úî Powered by LangChain + LangGraph  
‚úî Uses live search tools  
‚úî Transparent & honest  
""")


st.markdown("---")


# =========================
#   LOCATION INPUTS
# =========================
st.header("üìç Travel Details")

# --- Departure ---
from_input = st.text_input("Type your departure city (e.g., Shimla)")

from_choice = None
from_results = []

if from_input:
    from_results = search_location(from_input)

    if from_results:
        from_choice = st.selectbox(
            "Confirm your location",
            [loc["label"] for loc in from_results]
        )


# --- Destination ---
to_input = st.text_input("Type destination city")

to_choice = None
to_results = []

if to_input:
    to_results = search_location(to_input)

    if to_results:
        to_choice = st.selectbox(
            "Confirm destination",
            [loc["label"] for loc in to_results]
        )


# =========================
#   PEOPLE & DAYS
# =========================
st.header("üë• Group Details")

people = st.number_input("Number of Travelers", min_value=1, max_value=20, value=2)
days = st.number_input("Number of Days", min_value=1, max_value=30, value=3)

group_type = st.radio(
    "Who are you travelling with?",
    ["Solo", "Friends", "Family", "Couple"]
)


# =========================
#   BUDGET
# =========================
st.header("üí∏ Hotel Budget (Per Night)")

hotel_budget = st.selectbox(
    "Budget Category",
    [
        "‚Çπ0-1000 / ‚Ç¨0-10",
        "‚Çπ1000-3000 / ‚Ç¨10-30",
        "‚Çπ3000-6000 / ‚Ç¨30-60",
        "‚Çπ6000-12000 / ‚Ç¨60-120",
        "Luxury ‚Äî No Limit"
    ]
)


# =========================
#   TRANSPORT
# =========================
st.header("üöó Travel Mode Preference")

transport = st.radio(
    "Primary Mode",
    ["Flight", "Train", "Bus / Road Trip"]
)


# =========================
#   FOOD
# =========================
st.header("üçΩ Food Preference")

food_type = st.radio("Diet Type", ["Veg Only", "Non-Veg", "Mixed"])

food_style = st.radio(
    "Preferred Food Experience",
    [
        "Local & Authentic",
        "Trendy / Aesthetic Cafes",
        "Street Food Explorer",
        "Fine Dining"
    ]
)


# =========================
#   TRIP STYLE
# =========================
st.header("üéØ Trip Theme")

trip_theme = st.multiselect(
    "Select Trip Style",
    [
        "Budget Friendly",
        "Foodie Trip",
        "Nightlife",
        "Culture & History",
        "Nature & Scenic Views",
        "Relaxation",
        "Adventure Activities"
    ]
)


pace = st.radio(
    "Trip Speed",
    ["Relaxed", "Balanced", "Cover Max Places"]
)


stay_type = st.radio(
    "Stay Type",
    ["Hostel", "Budget Hotel", "Mid-Range", "Luxury", "Any"]
)


notes = st.text_area(
    "Anything else? (optional)",
    placeholder="Example: senior citizens travelling / honeymoon / prefer walkable areas"
)


st.markdown("---")


# =========================
#   PROMPT BUILDER
# =========================
def build_prompt():
    from_city = from_choice or from_input or "Not specified"
    to_city = to_choice or to_input or "Not specified"

    return f"""
"You are TripGenie, an intelligent, transparent, non-commercial AI travel planner "
        "created for an educational project. Your goal is to create detailed, realistic itineraries "
        "based on real-time data.\n\n"
        "GUIDELINES:\n"
        "1. TRANSPARENCY: When you recommend a hotel or flight, you MUST cite the source or tool you used.\n"
        "2. ACCURACY: Do not guess prices. Use your search tools to find current estimates.\n"
        "3. FORMAT: Organize itineraries with clear Markdown headers and bullet points.\n"
        "4. FALLBACK: If you cannot find specific data, admit it honestly rather than hallucinating.\n"
    )
Plan a realistic {days}-day trip.

FROM
{from_city}

TO
{to_city}

TRAVELERS
{people} people ‚Äî {group_type}

TRANSPORT
{transport}

HOTEL BUDGET
{hotel_budget}
Preferred stay: {stay_type}

FOOD
Diet: {food_type}
Style: {food_style}

TRIP STYLE
{", ".join(trip_theme) if trip_theme else "Not specified"}
Pace: {pace}

OTHER NOTES
{notes if notes else "None"}

RULES
- Use real online info via tools
- Convert prices into EUR or local currency
- Show daily plan clearly
- Keep tone friendly
- Admit uncertainty if unsure
"""


# =========================
#   SUBMIT BUTTON
# =========================
if st.button("‚ú® Generate My Trip Plan"):
    if not from_choice or not to_choice:
        st.warning("Please confirm both locations üôÇ")
    else:
        with st.spinner("TripGenie is planning your trip..."):
            prompt = build_prompt()
            response = get_trip_plan(prompt)

            st.success("Your Trip Plan is Ready üéâ")
            st.markdown(response)


st.markdown("---")
st.caption("TripGenie ‚Ä¢ Educational AI Travel Assistant ‚Ä¢ Built with LangGraph & Streamlit")
